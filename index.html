<!doctype html>
<html>
	<head>
		 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   		 integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   		 crossorigin=""/>
   		 <script src="node_modules/leaflet/dist/leaflet.js"></script>
   		 <script src="node_modules/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
	<body>
		<div id='map' style='width: 1200px; height: 800px;'></div>
		<div class="slidecontainer">
  			<input type="range" min="1900" max="2018" value="2018" class="slider" id="yearSlider">
  			<p>Year: <span id="outputYear"></span></p>
		</div>
		<script src="geodata.js" type="text/javascript"></script>
		<script>

		var slider = document.getElementById("yearSlider");
		var output = document.getElementById("outputYear");
		output.innerHTML = slider.value;

		var bounds = [
    		[51.029304, 6.439362], // Southwest coordinates
    		[51.440313, 7.244983]  // Northeast coordinates
		];

		var mymap = L.map('map').setView([51.218, 6.817], 12);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZHJqb25lczc0OTUiLCJhIjoiY2poYnI5d3NyMDUzcDMwcGRwN3l5cnV2biJ9.y2p2i2YCVH_smOxjpvT5yg', {
   			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    		minZoom: 11,
    		id: 'mapbox.streets',
    		access_token: 'pk.eyJ1IjoiZHJqb25lczc0OTUiLCJhIjoiY2poYnI5d3NyMDUzcDMwcGRwN3l5cnV2biJ9.y2p2i2YCVH_smOxjpvT5yg'
		}).addTo(mymap);

		mymap.setMaxBounds(bounds);

		L.geoJSON(stadtgrenze, {
   			style: {"color": "#ff7800", "fillOpacity": "0"}
		}).addTo(mymap);

		var usedFeatures;

		var line = {};

		var strassenbahnIcon = L.icon({
    		iconUrl: 'strassenbahn.png',
    		iconSize: [mymap.getZoom()*1.1, mymap.getZoom()*1.1],
    	});

    	var stadtbahnIcon = L.icon({
    		iconUrl: 'stadtbahn.png',
    		iconSize: [mymap.getZoom()*1.1, mymap.getZoom()*1.1],
    	});

		function drawLine(route) {
			if (line != undefined) {
            	mymap.removeLayer(line);
         	};
			line = L.geoJSON(route, {
				filter: function(feature, layer) {
					if (checkYear(feature)) {
						return true;
					} else {
						return false;
					}
				},
				style: function(feature, layer) {
        			switch (feature.properties.tunnel) {
            			case 'yes': return {color: "#ff0000", dashArray: "1,6"};
            			default: return {color: "#ff0000"}
        			}
   				},
   				pointToLayer: function (feature, latlng) {
   					getIconSize();
   					switch (feature.properties.underground) {
            			case 'yes': return L.marker(latlng, {icon: stadtbahnIcon});
            			default: return L.marker(latlng, {icon: strassenbahnIcon});
        			}
    			}
			}).addTo(mymap);
			getLayersFromGeojson(route);
		}

		function getLayersFromGeojson(route) {
			var layers = line.getLayers();
			L.polylineDecorator(layers, {
        		patterns: [
            		{offset: 25, repeat: 30, symbol: L.Symbol.arrowHead({pixelSize: 15, pathOptions: {fillOpacity: 1, weight: 0, color: "#0000FF"}})}
        	]
   			}).addTo(mymap);
		}

		function checkYear(feature) {
			var featureStartYear = parseInt(feature.properties.startYear);
			var featureEndYear = parseInt(feature.properties.endYear);
			var sliderYear = parseInt(slider.value);
			if (featureStartYear < sliderYear && featureEndYear > sliderYear) {
				return true;
			} else {
				return false;
			}
		}

		function getIconSize() {
			var zoomLev = mymap.getZoom();
			strassenbahnIcon = L.icon({
    			iconUrl: 'strassenbahn.png',
    			iconSize: [zoomLev, zoomLev],
    		});
    		stadtbahnIcon = L.icon({
    			iconUrl: 'stadtbahn.png',
    			iconSize: [zoomLev, zoomLev],
    		});
		}

		slider.addEventListener("input", function(){output.innerHTML = this.value}, false);
		slider.addEventListener("input", function(){drawLine(u73); }, false);
		mymap.on("zoom", function(){drawLine(u73); });

// var popup = L.popup();
// function onMapClick(e) {
// 	zoomLev = mymap.getZoom();
//     popup
//         .setLatLng(e.latlng)
//         .setContent("Zoom Level: " + zoomLev + " .You clicked the map at " + e.latlng.toString())
//         .openOn(mymap);
// }
// mymap.on('click', onMapClick);
		</script>
	</body>
</html>